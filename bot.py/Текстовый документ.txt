import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.enums import ParseMode
from aiogram.types import FSInputFile
from rembg import remove
from io import BytesIO
from PIL import Image

TOKEN = "7590497355:AAHwp-K_Ibl_whi_Z79IMryQiqFIZsKSra8"

from aiogram.client.default import DefaultBotProperties

bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(lambda message: message.text == "/start")
async def start_command(message: types.Message):
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.\n\n"
        "üìå –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –ª—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n"
        "2Ô∏è‚É£ –Ø –æ–±—Ä–∞–±–æ—Ç–∞—é –µ–≥–æ –∏ –ø—Ä–∏—à–ª—é —Ç–µ–±–µ –±–µ–∑ —Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG.\n"
        "3Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–≤–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö!\n\n"
        "‚ö†Ô∏è –ß–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–µ–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —Ñ–æ–Ω–µ, —Ç–µ–º –ª—É—á—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç."
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
@dp.message(lambda message: message.photo)
async def remove_bg(message: types.Message):
    photo = message.photo[-1]
    photo_bytes = BytesIO()
    file = await bot.get_file(photo.file_id)
    await bot.download_file(file.file_path, destination=photo_bytes)   

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º (—Ç–≤–æ–π –∫–æ–¥ —Ç—É—Ç)
    input_image = Image.open(photo_bytes)
    output_image = remove(input_image)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º rembg –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞

    output_path = "no_bg.png"
    output_image.save(output_path, format="PNG")  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª, —á—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª–æ—Å—å
    await message.answer_document(document=FSInputFile(output_path), caption="‚úÖ –í–æ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ —Ñ–æ–Ω–∞!")


async def main():
    logging.basicConfig(level=logging.INFO)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())